# Isaac Simulator Handler - 2021.2.1

## Isaac 2022 version of these scripts is almost complete

## Pre-requisites

For 2021 version use the following as Nucleus server in the omniverse launcher:
```
Name: Isaac
Type: Amazon S3
Host: d28dzv1nop4bat.cloudfront.net
Service: s3
Redirection: https://d28dzv1nop4bat.cloudfront.net
```

For 2022 this should not be necessary.

### Dependencies

To install python dependencies run `sh req.sh $ISAAC_FOLDER`. *Warning* most of them are _not_ related to `ros`, so this is non-skippable.
(This will simply use the main Isaac `python.sh` to install everything via `pip`).


## Ways to run

In all branches you will find a `simulator` folder with all the utils. 

There are three main files as of now:
1. `paper_simulation.py`: this is the script we used to generate the data. It will load the environment, place the robot following the strategy described in the paper, and perform an autonomous exploration using the `FUEL` manager. This is a somehow convoluted script that has a lot of unnecessary details for a first time user. This will also require installing a `catkin_ws`. Instructions for this can be found [TODO here]().
2. `simulator_ros.py`: this is a stripped version of the above. It will still require some ROS integration (as our placement strategy depend on it for now) but it is a much simple read and easy to follow workflow. For simplicity you can install again the full `catkin_ws` (read [TODO here]()). Comparing `1` and `2` should let you integrate your own ROS package.
3. `simulator_wo_ros.py`: this is a stripped version of the above. ROS is completely "disabled", meaning that you can run it without installing any `catkin_ws`. It will still publish to ROS and save the npy data. 

We did our best to update all branches in parallel if bug were found. However, if something is not working please open an issue.

## Branches

We have 3 main branches based on `IsaacSim 2021.2.1`
1. `main`: this is the main branch. Install this to have the most updated one and test out our data generatio we developed for the paper.
2. `savana`: this is a showcase branch. It works very similar to the `main` branch but has some specific use-case to load the `Savana` environment, the `Zebras` and generate the `Savana` demo data.
3. `irotate`: this is a showcase branch. It has been done to integrate our `Active SLAM` method `iRotate` in IsaacSim. There is a specific configuration setting as well as minor modifications.
We have 1 branch based on `IsaacSim 2022.1.1`
4. `v2022`

Note: Merging of 1, 2 and 3 is being planned. 

#### ROS-packages \[if desired\]

Install ROS and create a `catkin_ws` and install [this](https://github.com/eliabntt/ros_isaac_drone).

The default location for this installation is `$HOME` (`/home/user/catkin_ws`).

The repo above will install 
1. `FUEL`, our chosen exploration manager
2. `mav_comm` and `mav_control_rw` which are used to control the robot and get velocity commands to follow the path generated by `FUEL`
3. `custom_6dof_joint_controller` which is the bridge between the position/velocity commands and the joint velocities expected by IsaacSim
4. `moveit_based_collision_checker_and_placement` which is needed to do the placement of the "objects"

The [README](https://github.com/eliabntt/ros_isaac_drone/blob/main/README.md) already explicate the dependencies.

If you install it in a different location _update `setup_python_env.sh:2`_ with your new location.

Remember that you can also `source ... --extend` to source different environments in cascade.

### ROS-independence

The main things dependent on ROS are:
1. The placement procedure (look for `position_object`, you can override/edit it how you like)
2. The ROS components attached to the robot/camera. Depending on which level of independence you want you might disable everything or keep the joint and tf publishers. Note that every viewport is a burden on the system. Also, every time you publish camera data through ROS there is some overhead.

### Movement strategies

You have several possibilities. 

With ROS:
1. Use a 6 joints mechanism as we do. Implement your own and loop it back through ROS as we have done with `FUEL`. You can edit the `custom_joint_6dof_controller` or directly publish `joint_commands`. This is doable even directly within the main simulation loop as it is setted up to already be a node. You can manage this from the main simulation loop (as in `paper_simulation`) or from another program as we do with `iRotate`
2. Use an embedded controller provided by IssacSim and publish `cmd_vel` or `moveit` commands dependending on your use case.
3. Launch a python script through the Isaac `python.sh` and use ROS and `joint_commands` to read the robot location (listen to the `joint_states` or odom topics) and follow your path.

Without ROS:
1. Move the robot by sending joint position/velocity commands directly from IsaacSim. An example of this has been implemented on the `Savana` branch. This will output physics and will abide the settings that you use for your joints (mass, force...). 
2. Use a strategy like the one we use for the [flying objects](https://github.com/eliabntt/isaac_sim_manager/blob/main/simulator/objects_utils.py#L166). However, this does NOT include physics, collision or anything similar whatsoever. In this case the trajectory is followed blindly and interpolated based on your settings.
3. Use the IsaacSim KeyFrame extension visually to manually set up 2. beforehand.

## Use/Copy/Move/Link the code

You have two options. 
1. Run everything directly from the cloned repository. `./python.sh clone_path/simulator/simulator_ros.py ....`. In this case you need to run once `./cp_essential_to_isaac.sh ISAAC_FOLDER`. This will copy `apps/*`, `exts/*` and a couple of other files directly into the Isaac installation such that the edits are being loaded correctly. If you change any of those files remember you need to do the same. 
2. Run `./cp_local_to_diff_folder.sh $ISAAC_FOLDER`. This will copy all the utils and the code edits into the corresponding folders of the IsaacSim environment. `./python.sh simulator/simulator_ros.py ...` will then be used to launch the simulation. This means that you can update the code here and easily copy all to your other folder. Once you are satisfied you can just run `./cp_local_to_diff_folder.sh $GIT_FOLDER` from the ISAAC_FOLDER to copy back to the repository and eventually commit and push your changes.

### Scripts

`kill.sh` can kill all the processes launched during the simulation, effectively killing all possible instances of isaac sim and ros.

You can easily edit that to add/remove stuff that you want to kill if the simulation is hanging.

It is suggested that you use `kill.sh && python.sh simulator_ros.py ...` as sometimes a ROS package or Isaac itself might be left hanging.

### Notes

In `setup_python_env.sh` we had to prevent the loading of `$SCRIPT_DIR/exts/omni.isaac.motion_planning/bin` (you can find it commented at the very end of line 8), to be able to run the system version of `move_base`. That module could be necessary for some of the Isaac extensions or configurations. Please be aware of this.

## How to run

At this point, from the ISAAC folder you can run 
```
./python.sh simulator/simulator_ros.py [--/renderer/enabled='rtx,iray'] --neverending=True --rtx_mode=True --record=False  --config="/GLOBAL/simulator/config.yaml" 
```

`python.sh` will load all the necessary packages
`simulator/simulator_ros.py` is the path of the main python.
`--/renderer/enabled='rtx,iray'` makes sure that `iray` is enabled. You can safely remove this.

All the parameters are optional with the exception of the config file.
If you remove something from the config file please be sure that is not used in the code. Otherwise, it will crash. 

You can see a detailed explanation of the parameters and of the config file [here](https://github.com/eliabntt/isaac_sim_manager/blob/main/PARAMS.md).

*BASH PROCESSING*
If you want to run everything (including the exploration visualization and the rosbag recorder) the `bash_process.zsh` file is what you are looking for.
That file is what we used to streamline the generation and process in batches. In the config file you can easily chose which sensor to use.
Be aware that `motion-vector` is NOT working (IsaacSim bug) and that enabling everything will save a _lot_ of data.


## How to anonymize? How to convert USD binary to TEXT? How to change paths _before_ loading the `usd` file?

Install `USD` package from [here](https://github.com/PixarAnimationStudios/USD/).
Then take the saved usd and do:
`mv original.usd original.usdc`
`usdcat -o original_text.usda original.usdc`
Then you can process `original_text.usda` with a text editor/python script/whatever you like.

## Possible missing textures/wrong paths

When loading humans or environments (or anything else) it might happen that you need to edit the paths of the shaders, especially when moving between Windows and Linux.
To do that you can use the `change_shader_path` (line: 56, `utils.py`) or the `correct_paths` (line: 111, `utils.py`). <!---### TODO put links--->
Please note that you need to tailor this to your own use case.
The `correct_paths` function is already commented in `human_utils` when loading the human and in `environment_utils` when loading the env. 

Otherwise, you can simply process the text files as explained above and load the new ones.

### Code explanation
Most of the functions in the utils libraries are commented and explained. 
The explanation of the main piece of code can be found [here](https://github.com/eliabntt/isaac_sim_manager/blob/main/HOW_IT_WORKS.md)

### Segmentation <-> instance
Instance segmentation files will save also the mappings. 
Note that the segmentation returned from IsaacSim is `id % id_max`.
This implies that the `human` which has ID `34` on our mapping is returned as `34` if you just do `instance[i][j] = mapping[instance[i][j]][2]` but as `0` if you save the semantic information from the data saver.

### Branches
Savana -> todo write how to use
irotate -> todo write how to use
